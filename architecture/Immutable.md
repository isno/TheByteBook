# 1.4.4 基础设施不可变化

谈论不可变基础设施（Immutable Infrastructure）之前，我们先看一下 Immutable 和 Mutable 的不同之处。从基础设施的角度来看，Mutable 更倾向于传统的运维视角。例如 现有的主机部署的是 Apache 想换成 Nginx，需要现卸载掉 Apache，然后再重新安装一个 Nginx，然后再重启让系统对这次变更生效。在这个过程中，基础设施为了满足业务需求，进行了一次或多次变更，这就是一个可变的基础设施。

可变的基础设施通常会导致以下问题：

- 重大故障时，难以快速重新构建服务：持续过多的手动操作，缺乏记录，会导致很难由标准初始化的服务器来重新构建起等效的服务。
- 不一致风险：在服务运行过程中，持续的修改基础设施配置等，就像程序变量因并发修改引起的状态不一致风险，这对服务器修改而言，同样会引入中间状态，导致出现不可预知的问题。

Immutable 的核心思想是任何基础设施的实例一旦创建之后就变成只读状态，如需修改或升级，应该先修改基础设施的公共配置模版，修改配置模版之后使用新的实例进行替换。如果有新的变更需求，如上面的 Nginx 升级案例，就应该准备一个新的 Nginx 基础设施，而不是在原有的基础上做本地更新。

<div  align="center">
	<img src="../assets/Immutable.png" width = "580"  align=center />
</div>

介绍完上面的概念之后，读者应该想起前面篇节介绍的容器技术。我们构建镜像运行容器之后，如果出现问题，我们不会在容器内修改解决，而是在容器构建阶段去解决，从容器的角度，镜像就是一个不可变基础设施。容器技术出现之后，使不同环境的标准化配置成为可能，我们可以快速拉起成千上万一模一样的服务，服务的版本升级、回滚成为常态，进而不可变基础设施也逐步变成可能。

总结不可变基础设施的优点：

- 一致性：在不可变基础设施下，所有的配置都通过标准化的描述文件（例如 yaml、dockerfile）进行统一定义，不同的 Pod、Service 都按照同样的定义创建，不同服务之间配置不一致的情况不再出现。
- 自动化快速容灾：当线上突发故障或者遇到异常流量时，不可变基础设施可以快速进行弹性扩缩容、升级、回滚等操作，应对问题时更加快速和自动化，大幅提升持续部署效率。